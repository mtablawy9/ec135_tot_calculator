<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EC135 PW206B2 Inflight Power Check (with Filters)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/1.1.0/modern-normalize.min.css">
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 16px; }
  h1 { text-align: center; }
  label { display:block; margin-top:8px; }
  input[type="number"], input[type="text"] { width:140px; padding:6px; margin-right:8px; }
  .row { display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:8px; }
  #calculate { margin-top:12px; padding:8px 14px; }
  #results { margin-top:16px; background:#f8f8f8; padding:12px; border-radius:6px; }
  #plot { margin-top:18px; }
  .note { font-size:0.9em; color:#444; margin-top:6px; }
</style>
</head>
<body>
  <h1>EC135 PW206B2 Inflight Power Check</h1>
  <p class="note">Measured TOT entry may be adjusted depending on installed filters. (Sand Filter = -25°C, IBF = -12°C). If both are checked, Sand Filter takes priority.</p>

  <div>
    <label>Pressure Altitude (ft):
      <input id="pa" type="number" value="0" step="1" />
    </label>

    <label>Outside Air Temperature (°C):
      <input id="oat" type="number" value="15" step="0.1" />
    </label>

    <label>Measured TOT from engine (°C) (input before any adjustment):
      <input id="meas" type="number" value="700" step="0.1" />
    </label>

    <label>
      <input type="checkbox" id="sandFilter"> Sand Filter Installed (apply -25°C)
    </label>
    <label>
      <input type="checkbox" id="ibfFilter"> IBF Installed (apply -12°C)
    </label>

    <label>Plot chart?
      <input id="doplot" type="checkbox" checked />
    </label>

    <div class="row">
      <button id="calculate">Calculate</button>
      <button id="downloadPdf" style="display:none">Download PDF Report</button>
      <button id="reset">Reset</button>
    </div>
  </div>

  <div id="results" style="display:none">
    <div id="expectedLine"></div>
    <div id="measuredLine"></div>
    <div id="deltaLine"></div>
  </div>

  <div id="plot" style="display:none">
    <div id="chart" style="width:100%;height:520px;"></div>
  </div>

<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
(() => {
  // Fixed bias-corrected coefficients (as requested)
  const A0 = 660;              // Intercept at PA=0 ft
  const B0 = 2.50;             // OAT slope at PA=0 ft
  const c_intercept = 0.00775; // Intercept increase per ft
  const c_slope = 0.000075;    // Slope increase per ft

  const MCP_LIMIT = 835; // MCP line

  const el = id => document.getElementById(id);

  function tot_fn(pa, oat) {
    // returns TOT for given pa and oat
    return A0 + c_intercept * pa + (B0 + c_slope * pa) * oat;
  }

  function calculateAndShow() {
    const PA = parseFloat(el('pa').value);
    const OAT = parseFloat(el('oat').value);
    const measuredInput = parseFloat(el('meas').value);
    const doplot = el('doplot').checked;

    // basic validation
    if (isNaN(PA) || PA < -1000 || PA > 50000) { alert('Enter a valid Pressure Altitude (ft) between -1000 and 50000'); return; }
    if (isNaN(OAT) || OAT < -80 || OAT > 80) { alert('Enter a valid OAT (°C) between -80 and 80'); return; }
    if (isNaN(measuredInput) || measuredInput <= 0) { alert('Enter a valid measured TOT (°C)'); return; }

    // filter checkboxes
    const hasSandFilter = el('sandFilter').checked;
    const hasIBF = el('ibfFilter').checked;

    // apply adjustment logic: Sand has priority if both checked
    let TOT_measured = measuredInput;
    if (hasSandFilter) {
      TOT_measured -= 25;
    } else if (hasIBF) {
      TOT_measured -= 12;
    }

    const TOT_expected = tot_fn(PA, OAT);
    const delta = TOT_expected - TOT_measured;

    // show numeric results
    el('results').style.display = 'block';
    el('expectedLine').innerHTML = `<strong>Expected TOT:</strong> ${TOT_expected.toFixed(1)} °C`;
    const adjText = hasSandFilter ? "(adjusted -25°C for Sand Filter)" :
                    (hasIBF ? "(adjusted -12°C for IBF)" : "(no adjustment)");
    el('measuredLine').innerHTML = `<strong>Measured TOT:</strong> ${TOT_measured.toFixed(1)} °C ${adjText}`;
    el('deltaLine').innerHTML = `<strong>ΔTOT (Expected - Measured):</strong> ${delta.toFixed(1)} °C`;

    // show download button
    el('downloadPdf').style.display = 'inline-block';

    // plot if requested
    if (doplot) {
      el('plot').style.display = 'block';
      drawPlot(PA, OAT, TOT_expected, TOT_measured);
    } else {
      el('plot').style.display = 'none';
    }
  }

  function drawPlot(PA_input, OAT_input, TOT_expected, TOT_measured) {
    const OAT_MIN = Math.min(-50, Math.floor(OAT_input) - 10);
    const OAT_MAX = Math.max(50, Math.ceil(OAT_input) + 10);
    const OAT_vec = [];
    for (let v = OAT_MIN; v <= OAT_MAX; v += 1) OAT_vec.push(v);

    const PA_list = [0,2000,4000,6000,8000,10000];

    const traces = [];

    // plot lines for each PA
    PA_list.forEach(pa => {
      const y = OAT_vec.map(o => tot_fn(pa, o));
      traces.push({
        x: OAT_vec,
        y: y,
        mode: 'lines',
        name: `PA = ${pa} ft`,
        line: {width: 2}
      });
    });

    // expected point
    traces.push({
      x: [OAT_input],
      y: [TOT_expected],
      mode: 'markers',
      name: 'Expected point',
      marker: {color: 'black', size: 10, symbol: 'circle'}
    });

    // measured point
    traces.push({
      x: [OAT_input],
      y: [TOT_measured],
      mode: 'markers',
      name: 'Measured point',
      marker: {color: 'red', size: 12, symbol: 'x'}
    });

    // MCP line
    traces.push({
      x: [OAT_vec[0], OAT_vec[OAT_vec.length-1]],
      y: [MCP_LIMIT, MCP_LIMIT],
      mode: 'lines',
      name: 'MCP Limit (~835 °C)',
      line: {dash: 'dash', color: 'purple', width: 2}
    });

    const layout = {
      title: 'EC135 PW206B2 Inflight Power Check (60% Torque, Bleed OFF)',
      xaxis: {title: 'OAT (°C)'},
      yaxis: {title: 'TOT (°C)'},
      showlegend: true,
      legend: {orientation: 'v'}
    };

    Plotly.newPlot('chart', traces, layout, {responsive:true});
    
    // annotate delta between points
    const midY = (TOT_expected + TOT_measured)/2;
    const xAnnot = Math.min(Math.max(OAT_input + 1, OAT_vec[0]), OAT_vec[OAT_vec.length-1]);
    const annotation = {
      x: xAnnot,
      y: midY,
      text: `ΔTOT = ${ (TOT_expected - TOT_measured).toFixed(1) } °C`,
      showarrow: false,
      font: {color: 'blue', size:12}
    };
    Plotly.relayout('chart', {'annotations': [annotation]});
  }

  // PDF download
  async function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const name = 'EC135_TOT_Report';
    const PA = parseFloat(el('pa').value);
    const OAT = parseFloat(el('oat').value);
    const measuredInput = parseFloat(el('meas').value);
    const hasSandFilter = el('sandFilter').checked;
    const hasIBF = el('ibfFilter').checked;
    let TOT_measured = measuredInput;
    if (hasSandFilter) TOT_measured -= 25;
    else if (hasIBF) TOT_measured -= 12;
    const TOT_expected = tot_fn(PA, OAT);
    const delta = TOT_expected - TOT_measured;
    const date = new Date().toLocaleString();

    doc.setFontSize(14);
    doc.text('EC135 PW206B2 Inflight Power Check Report', 12, 20);
    doc.setFontSize(11);
    doc.text(`Date: ${date}`, 12, 30);
    doc.text(`Pressure Altitude (ft): ${PA}`, 12, 40);
    doc.text(`OAT (°C): ${OAT}`, 12, 48);
    doc.text(`Measured TOT (input) (°C): ${measuredInput.toFixed(1)}`, 12, 56);
    const adjText = hasSandFilter ? 'Adjusted -25°C (Sand Filter)' : (hasIBF ? 'Adjusted -12°C (IBF)' : 'No adjustment');
    doc.text(`Adjustment: ${adjText}`, 12, 64);
    doc.text(`Measured TOT (after adj) (°C): ${TOT_measured.toFixed(1)}`, 12, 72);
    doc.text(`Expected TOT (°C): ${TOT_expected.toFixed(1)}`, 12, 80);
    doc.text(`ΔTOT (Expected - Measured) (°C): ${delta.toFixed(1)}`, 12, 88);

    // embed chart if available
    try {
      const chartEl = document.getElementById('chart');
      if (chartEl && chartEl.data && chartEl.data.length > 0) {
        const imgData = await Plotly.toImage('chart', {format:'png', width:800, height:450});
        doc.addImage(imgData, 'PNG', 12, 95, 180, 100);
      }
    } catch (e) {
      // ignore chart embed failures
    }

    doc.save(`${name}.pdf`);
  }

  // event listeners
  el('calculate').addEventListener('click', calculateAndShow);
  el('downloadPdf').addEventListener('click', () => { downloadPDF(); });
  el('reset').addEventListener('click', () => {
    el('pa').value = 0; el('oat').value = 15; el('meas').value = 700; el('doplot').checked = true;
    el('sandFilter').checked = false; el('ibfFilter').checked = false;
    el('results').style.display='none'; el('plot').style.display='none'; el('downloadPdf').style.display='none';
    try { Plotly.purge('chart'); } catch(e){}
  });

})();
</script>
</body>
</html>